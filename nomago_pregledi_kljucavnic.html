<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nomago Baza – Preglej me!</title>
  <style>
    :root {
      --primary: #ffbb33;
      --primary-dark: #223957;
      --ok: #4caf50;
      --fail: #e53935;
      --warn: #fb8c00;
      --lockfail: #3f51b5;
      --unlockfail: #9c27b0;
      --overdue: #d32f2f;
      --due-soon: #f57c00;
      --radius: 8px;
      --shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f5f7fa;
      color: #333;
      margin: 0;
      padding: 0;
    }
    
    header {
      background: var(--primary);
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow);
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .back-button {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: var(--radius);
      cursor: pointer;
      text-decoration: none;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    
    .back-button:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .user-display {
      color: white;
      font-size: 0.9rem;
      background: rgba(255,255,255,0.1);
      padding: 4px 12px;
      border-radius: 12px;
    }
    
    .container {
      padding: 12px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .alerts-bar {
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .alert {
      padding: 12px;
      border-radius: var(--radius);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 500;
    }
    
    .alert-overdue {
      background: rgba(211, 47, 47, 0.1);
      color: var(--overdue);
      border: 1px solid rgba(211, 47, 47, 0.3);
    }
    
    .alert-due-soon {
      background: rgba(245, 124, 0, 0.1);
      color: var(--due-soon);
      border: 1px solid rgba(245, 124, 0, 0.3);
    }
    
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
      background: white;
      padding: 12px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    
    select, input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      min-width: 160px;
    }
    
    .location-card {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      overflow: hidden;
      position: relative;
    }
    
    .location-card.has-overdue {
      border-left: 4px solid var(--overdue);
    }
    
    .location-card.has-due-soon {
      border-left: 4px solid var(--due-soon);
    }
    
    .location-header {
      background: var(--primary-dark);
      color: white;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .location-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .location-alerts {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .alert-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .alert-badge.overdue {
      background: var(--overdue);
      color: white;
    }
    
    .alert-badge.due-soon {
      background: var(--due-soon);
      color: white;
    }
    
    .location-body {
      padding: 12px;
    }
    
    .rack-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
    }
    
    .rack-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 10px;
      border: 2px solid #eee;
      border-radius: var(--radius);
      position: relative;
      transition: all 0.3s ease;
      min-width: 140px;
    }
    
    .rack-item.overdue {
      border-color: var(--overdue);
      background: rgba(211, 47, 47, 0.05);
      animation: pulse-red 2s infinite;
    }
    
    .rack-item.due-soon {
      border-color: var(--due-soon);
      background: rgba(245, 124, 0, 0.05);
    }
    
    @keyframes pulse-red {
      0%, 100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(211, 47, 47, 0); }
    }
    
    .rack-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin-bottom: 8px;
    }
    
    .rack-number {
      font-weight: bold;
      font-size: 1.1rem;
    }
    
    .inspection-due {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
    }
    
    .inspection-due.overdue {
      background: var(--overdue);
      color: white;
    }
    
    .inspection-due.due-soon {
      background: var(--due-soon);
      color: white;
    }
    
    .inspection-due.ok {
      background: var(--ok);
      color: white;
    }
    
    .last-inspection {
      font-size: 0.7rem;
      color: #666;
      margin-bottom: 4px;
      text-align: center;
    }
    
    .rack-select {
      width: 100%;
      max-width: 120px;
      padding: 6px 8px;
      border-radius: var(--radius);
      border: 2px solid #ddd;
      text-align: center;
      cursor: pointer;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 0.85rem;
      background: white;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 6px center;
      background-size: 14px;
      padding-right: 24px;
      transition: all 0.3s ease;
    }
    
    .rack-select:hover {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(255, 187, 51, 0.2);
    }
    
    .rack-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 187, 51, 0.3);
    }
    
    .inspection-notes {
      width: 100%;
      padding: 4px 6px;
      border-radius: var(--radius);
      border: 1px solid #ddd;
      font-size: 0.8rem;
      resize: vertical;
      height: 40px;
    }
    
    /* Status barve */
    .status-BP { background: var(--ok); color: white; }
    .status-X { background: var(--fail); color: white; }
    .status-NP { background: var(--warn); color: white; }
    .status-NZ { background: var(--lockfail); color: white; }
    .status-NO { background: var(--unlockfail); color: white; }
    
    /* Status panel - REMOVED */
    .status-panel {
      display: none !important;
    }
    
    .export-button {
      background: var(--primary-dark);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      margin-left: 8px;
    }
    
    .summary-card {
      background: white;
      padding: 16px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    
    .summary-item {
      text-align: center;
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid #eee;
    }
    
    .summary-number {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 4px;
    }
    
    .summary-label {
      font-size: 0.9rem;
      color: #666;
    }
    
          @media (max-width: 600px) {
      .rack-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
      
      .filter-bar {
        flex-direction: column;
      }
      
      select, input {
        width: 100%;
      }
      
      .summary-card {
        grid-template-columns: 1fr 1fr;
      }
      
      .status-panel {
        display: none !important;
      }
    }
  </style>
  
  <!-- Modal for inspection logs -->
  <div id="logsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;">
    <div style="background: white; margin: 2% auto; padding: 2rem; border-radius: 12px; max-width: 90%; max-height: 90%; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #eee; padding-bottom: 1rem;">
        <h2 style="color: var(--text-dark); margin: 0;">📋 Logi pregledov</h2>
        <button onclick="closeLogsModal()" style="background: var(--fail); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold;">✕ Zapri</button>
      </div>
      
      <div style="margin-bottom: 1rem;">
        <input type="text" id="logSearch" placeholder="Iskanje po lokaciji, terminalu, serviserju..." style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 8px;" oninput="filterLogs()">
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <select id="logTerminalFilter" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px;" onchange="filterLogs()">
            <option value="">Vsi terminali</option>
          </select>
          <select id="logStatusFilter" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px;" onchange="filterLogs()">
            <option value="">Vsi statusi</option>
            <option value="BP">BP</option>
            <option value="X">X</option>
            <option value="NP">NP</option>
            <option value="NZ">NZ</option>
            <option value="NO">NO</option>
          </select>
          <select id="logDateFilter" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px;" onchange="filterLogs()">
            <option value="">Vsi datumi</option>
            <option value="today">Danes</option>
            <option value="week">Zadnjih 7 dni</option>
            <option value="month">Zadnjih 30 dni</option>
          </select>
        </div>
      </div>
      
      <div id="logsContent" style="max-height: 60vh; overflow-y: auto;">
        <!-- Logs will be loaded here -->
      </div>
    </div>
  </div>
</head>
<body>
  <header>
    <div class="header-left">
      <a href="#" class="back-button" onclick="goBackToBaza()">← Nazaj v BAZO</a>
      <h1>Preglej me!</h1>
    </div>
    <div class="user-display" id="userDisplay">
      Uporabnik: Loading...
    </div>
  </header>
  
  <div class="container">
    <!-- Alerts for overdue and due soon inspections -->
    <div class="alerts-bar" id="alertsBar"></div>
    
    <!-- Summary statistics -->
    <div class="summary-card" id="summaryCard"></div>
    
    <div class="filter-bar">
      <select id="systemFilter">
        <option value="">Vsi sistemi</option>
        <option value="Ljubljana in Medvode">Ljubljana in Medvode</option>
        <option value="GO2GO">GO2GO</option>
        <option value="KOLESCE">KOLESCE</option>
        <option value="ZANAPREJ">ZANAPREJ</option>
      </select>
      
      <select id="municipalityFilter">
        <option value="">Vse občine</option>
      </select>
      
      <select id="statusFilter">
        <option value="">Vsi statusi</option>
        <option value="overdue">Zamujeni pregledi</option>
        <option value="due-soon">Pregledi kmalu</option>
        <option value="ok">V redu</option>
      </select>
      
      <input type="text" id="searchInput" placeholder="Iskanje...">
      
      <button class="export-button" onclick="exportInspectionReport()">
        📊 Izvozi poročilo
      </button>
      
      <button class="export-button" onclick="showInspectionLogs()" style="background: var(--primary); margin-left: 8px;">
        📋 Ogled logov
      </button>
    </div>

    <div id="locationsContainer"></div>
    
    <div class="status-panel">
      <div class="status-option status-BP" onclick="setStatus('BP')">BP</div>
      <div class="status-option status-X" onclick="setStatus('X')">X</div>
      <div class="status-option status-NP" onclick="setStatus('NP')">NP</div>
      <div class="status-option status-NZ" onclick="setStatus('NZ')">NZ</div>
      <div class="status-option status-NO" onclick="setStatus('NO')">NO</div>
    </div>
  </div>

  <script>
    // Get current user from BAZA portal
    const currentUser = JSON.parse(localStorage.getItem('serviserApp_currentUser') || '{}');
    
    // Display current user
    if (currentUser.ime) {
      document.getElementById('userDisplay').textContent = 
        `${currentUser.ime} ${currentUser.priimek} (${currentUser.vloga})`;
    }

    // Initialize inspection data structure
    function initializeInspectionData() {
      if (!localStorage.getItem('inspectionData')) {
        localStorage.setItem('inspectionData', JSON.stringify({}));
      }
      
      if (!localStorage.getItem('inspectionLog')) {
        localStorage.setItem('inspectionLog', JSON.stringify([]));
      }
    }

    // Calculate next inspection date (every 3 months)
    function getNextInspectionDate(lastInspection) {
      if (!lastInspection) {
        return new Date(); // If never inspected, it's overdue
      }
      
      const lastDate = new Date(lastInspection);
      const nextDate = new Date(lastDate);
      nextDate.setMonth(nextDate.getMonth() + 3);
      return nextDate;
    }

    // Get inspection status for a rack
    function getInspectionStatus(terminal, rackNumber) {
      const inspectionData = JSON.parse(localStorage.getItem('inspectionData') || '{}');
      const key = `${terminal}-${rackNumber}`;
      const rackData = inspectionData[key];
      
      if (!rackData || !rackData.lastInspection) {
        return 'overdue';
      }
      
      const nextDue = getNextInspectionDate(rackData.lastInspection);
      const now = new Date();
      const daysUntilDue = Math.ceil((nextDue - now) / (1000 * 60 * 60 * 24));
      
      if (daysUntilDue < 0) {
        return 'overdue';
      } else if (daysUntilDue <= 14) {
        return 'due-soon';
      } else {
        return 'ok';
      }
    }

    // Format inspection status display
    function formatInspectionStatus(status, nextDue) {
      const now = new Date();
      const daysUntilDue = Math.ceil((nextDue - now) / (1000 * 60 * 60 * 24));
      
      switch (status) {
        case 'overdue':
          const overdueDays = Math.abs(daysUntilDue);
          return { text: `${overdueDays}d ZAMUDA`, class: 'overdue' };
        case 'due-soon':
          return { text: `${daysUntilDue}d DO`, class: 'due-soon' };
        case 'ok':
          return { text: `${daysUntilDue}d`, class: 'ok' };
        default:
          return { text: 'N/A', class: 'ok' };
      }
    }

    // Update rack status and log the change
    function updateRackStatus(select) {
      const terminal = select.dataset.terminal;
      const rackNumber = select.dataset.rack;
      const newStatus = select.value;
      const notes = document.querySelector(`[data-terminal="${terminal}"][data-rack="${rackNumber}"].notes-input`).value;
      
      // Remove all status classes
      select.className = "rack-select";
      
      // Add current status class if selected
      if (newStatus) {
        select.classList.add(`status-${newStatus}`);
      }
      
      // Get old status for logging
      const inspectionData = JSON.parse(localStorage.getItem('inspectionData') || '{}');
      const key = `${terminal}-${rackNumber}`;
      const oldData = inspectionData[key] || {};
      const oldStatus = oldData.currentStatus || '';
      
      // Only update and log if there's actually a status change to something real
      if (newStatus) {
        // Update inspection data only if new status is not empty
        const now = new Date().toISOString();
        inspectionData[key] = {
          ...oldData,
          currentStatus: newStatus,
          lastInspection: now,
          notes: notes,
          inspector: currentUser.uporabniskoIme || 'unknown'
        };
        
        localStorage.setItem('inspectionData', JSON.stringify(inspectionData));
        
        // Log the change only if it's a real status (not empty)
        const log = JSON.parse(localStorage.getItem('inspectionLog') || '[]');
        log.push({
          timestamp: now,
          terminal: terminal,
          rackNumber: rackNumber,
          oldStatus: oldStatus,
          newStatus: newStatus,
          inspector: currentUser.uporabniskoIme || 'unknown',
          notes: notes
        });
        
        localStorage.setItem('inspectionLog', JSON.stringify(log));
        
        // Create notification for BAZA if status changed
        if (oldStatus !== newStatus) {
          createBazaNotification(terminal, rackNumber, oldStatus, newStatus, notes);
        }
      } else {
        // If new status is empty, completely remove this rack's data
        // This means it goes back to "never inspected" state
        if (inspectionData[key]) {
          delete inspectionData[key];
          localStorage.setItem('inspectionData', JSON.stringify(inspectionData));
        }
      }
      
      // Update the display
      updateLocationDisplay();
      updateAlerts();
      updateSummary();
      
      console.log(`Rack ${terminal}-${rackNumber} updated: ${oldStatus} → ${newStatus || 'reset to never inspected'}`);
    }

    // Create notification for BAZA portal
    function createBazaNotification(terminal, rackNumber, oldStatus, newStatus, notes) {
      if (newStatus === 'BP') return; // Don't notify for "good" status
      
      const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
      const location = ALL_LOCATIONS.find(loc => loc.terminal === terminal);
      const locationName = location ? location.name : terminal;
      
      let priority = 'normal';
      let type = 'warning';
      
      if (newStatus === 'X') {
        priority = 'urgent';
        type = 'error';
      } else if (newStatus === 'NZ' || newStatus === 'NO') {
        priority = 'high';
      }
      
      const statusNames = {
        'BP': 'V redu',
        'X': 'Okvarjena',
        'NP': 'Ne deluje pravilno',
        'NZ': 'Ne zaklene',
        'NO': 'Ne odklene'
      };
      
      const notification = {
        id: Date.now(),
        title: `Servisno obvestilo - ${locationName}`,
        message: `Ključavnica ${rackNumber} je označena kot "${statusNames[newStatus] || newStatus}". ${notes ? 'Opomba: ' + notes : ''}`,
        type: type,
        priority: priority,
        active: true,
        createdAt: new Date().toISOString(),
        createdBy: currentUser.uporabniskoIme || 'serviser'
      };
      
      notifications.unshift(notification);
      localStorage.setItem('notifications', JSON.stringify(notifications));
    }

    // Update alerts display
    function updateAlerts() {
      const alertsBar = document.getElementById('alertsBar');
      const overdue = [];
      const dueSoon = [];
      
      ALL_LOCATIONS.forEach(location => {
        for (let i = 1; i <= location.racks; i++) {
          const status = getInspectionStatus(location.terminal, i);
          if (status === 'overdue') {
            overdue.push(`${location.name} - Ključavnica ${i}`);
          } else if (status === 'due-soon') {
            dueSoon.push(`${location.name} - Ključavnica ${i}`);
          }
        }
      });
      
      let alertsHtml = '';
      
      if (overdue.length > 0) {
        alertsHtml += `
          <div class="alert alert-overdue">
            <span>⚠️ <strong>${overdue.length} zamujenih pregledov:</strong> ${overdue.slice(0, 3).join(', ')}${overdue.length > 3 ? ` in ${overdue.length - 3} več...` : ''}</span>
            <button onclick="filterOverdue()" style="background: var(--overdue); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">Prikaži vse</button>
          </div>
        `;
      }
      
      if (dueSoon.length > 0) {
        alertsHtml += `
          <div class="alert alert-due-soon">
            <span>📅 <strong>${dueSoon.length} pregledov kmalu:</strong> ${dueSoon.slice(0, 3).join(', ')}${dueSoon.length > 3 ? ` in ${dueSoon.length - 3} več...` : ''}</span>
            <button onclick="filterDueSoon()" style="background: var(--due-soon); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">Prikaži vse</button>
          </div>
        `;
      }
      
      alertsBar.innerHTML = alertsHtml;
    }

    // Update summary statistics
    function updateSummary() {
      let total = 0;
      let overdue = 0;
      let dueSoon = 0;
      let ok = 0;
      let needsMaintenance = 0;
      
      ALL_LOCATIONS.forEach(location => {
        for (let i = 1; i <= location.racks; i++) {
          total++;
          const status = getInspectionStatus(location.terminal, i);
          
          if (status === 'overdue') overdue++;
          else if (status === 'due-soon') dueSoon++;
          else ok++;
          
          // Check current maintenance status
          const inspectionData = JSON.parse(localStorage.getItem('inspectionData') || '{}');
          const key = `${location.terminal}-${i}`;
          const rackData = inspectionData[key];
          if (rackData && rackData.currentStatus && rackData.currentStatus !== 'BP') {
            needsMaintenance++;
          }
        }
      });
      
      const summaryCard = document.getElementById('summaryCard');
      summaryCard.innerHTML = `
        <div class="summary-item">
          <div class="summary-number">${total}</div>
          <div class="summary-label">Skupaj ključavnic</div>
        </div>
        <div class="summary-item" style="color: var(--overdue);">
          <div class="summary-number">${overdue}</div>
          <div class="summary-label">Zamujen pregled</div>
        </div>
        <div class="summary-item" style="color: var(--due-soon);">
          <div class="summary-number">${dueSoon}</div>
          <div class="summary-label">Pregled kmalu</div>
        </div>
        <div class="summary-item" style="color: var(--ok);">
          <div class="summary-number">${ok}</div>
          <div class="summary-label">V redu</div>
        </div>
        <div class="summary-item" style="color: var(--fail);">
          <div class="summary-number">${needsMaintenance}</div>
          <div class="summary-label">Potrebno vzdrževanje</div>
        </div>
      `;
    }

    // Filter functions
    function filterOverdue() {
      document.getElementById('statusFilter').value = 'overdue';
      filterLocations();
    }

    function filterDueSoon() {
      document.getElementById('statusFilter').value = 'due-soon';
      filterLocations();
    }

    // Enhanced location rendering with inspection status
    function renderLocations() {
      const container = document.getElementById("locationsContainer");
      container.innerHTML = "";
      
      ALL_LOCATIONS.forEach(location => {
        // Check if location has any overdue or due soon racks
        let hasOverdue = false;
        let hasDueSoon = false;
        
        for (let i = 1; i <= location.racks; i++) {
          const status = getInspectionStatus(location.terminal, i);
          if (status === 'overdue') hasOverdue = true;
          if (status === 'due-soon') hasDueSoon = true;
        }
        
        const card = document.createElement("div");
        card.className = "location-card";
        card.dataset.system = location.system;
        card.dataset.municipality = location.municipality;
        card.dataset.name = location.name.toLowerCase();
        card.dataset.terminal = location.terminal;
        
        if (hasOverdue) card.classList.add('has-overdue');
        else if (hasDueSoon) card.classList.add('has-due-soon');
        
        // Create alert badges
        let alertBadges = '';
        if (hasOverdue) {
          const overdueCount = Array.from({length: location.racks}, (_, i) => 
            getInspectionStatus(location.terminal, i + 1) === 'overdue').filter(Boolean).length;
          alertBadges += `<span class="alert-badge overdue">${overdueCount} zamujenih</span>`;
        }
        if (hasDueSoon) {
          const dueSoonCount = Array.from({length: location.racks}, (_, i) => 
            getInspectionStatus(location.terminal, i + 1) === 'due-soon').filter(Boolean).length;
          alertBadges += `<span class="alert-badge due-soon">${dueSoonCount} kmalu</span>`;
        }
        
        card.innerHTML = `
          <div class="location-header">
            <div class="location-info">
              <div style="font-weight: bold; font-size: 1.1rem;">${location.name}</div>
              <div style="font-size: 0.9rem; opacity: 0.9;">Terminal: ${location.terminal}</div>
            </div>
            <div class="location-alerts">
              ${alertBadges}
            </div>
          </div>
          <div class="location-body">
            <div style="margin-bottom: 12px; color: #666; font-size: 0.9rem;">
              ${location.system} • ${location.municipality}
            </div>
            <div class="rack-grid" id="racks-${location.terminal}"></div>
          </div>
        `;
        
        container.appendChild(card);
        
        const rackContainer = document.getElementById(`racks-${location.terminal}`);
        for (let i = 1; i <= location.racks; i++) {
          const inspectionStatus = getInspectionStatus(location.terminal, i);
          const nextDue = getNextInspectionDate(getLastInspectionDate(location.terminal, i));
          const statusInfo = formatInspectionStatus(inspectionStatus, nextDue);
          
          const inspectionData = JSON.parse(localStorage.getItem('inspectionData') || '{}');
          const key = `${location.terminal}-${i}`;
          const rackData = inspectionData[key] || {};
          
          const rackItem = document.createElement("div");
          rackItem.className = `rack-item ${inspectionStatus}`;
          rackItem.innerHTML = `
            <div class="rack-header">
              <div class="rack-number">${i}</div>
              <div class="inspection-due ${statusInfo.class}">${statusInfo.text}</div>
            </div>
            <div class="last-inspection">
              Zadnji: ${rackData.lastInspection ? 
                new Date(rackData.lastInspection).toLocaleDateString('sl-SI') : 'Nikoli'}
            </div>
            <select class="rack-select ${rackData.currentStatus ? `status-${rackData.currentStatus}` : ''}" 
                    data-terminal="${location.terminal}" 
                    data-rack="${i}"
                    onchange="updateRackStatus(this)">
              <option value=""></option>
              <option value="BP" ${rackData.currentStatus === 'BP' ? 'selected' : ''}>BP</option>
              <option value="X" ${rackData.currentStatus === 'X' ? 'selected' : ''}>X</option>
              <option value="NP" ${rackData.currentStatus === 'NP' ? 'selected' : ''}>NP</option>
              <option value="NZ" ${rackData.currentStatus === 'NZ' ? 'selected' : ''}>NZ</option>
              <option value="NO" ${rackData.currentStatus === 'NO' ? 'selected' : ''}>NO</option>
            </select>
            <textarea class="inspection-notes notes-input" 
                      data-terminal="${location.terminal}" 
                      data-rack="${i}"
                      placeholder="Opombe...">${rackData.notes || ''}</textarea>
          `;
          rackContainer.appendChild(rackItem);
        }
      });
    }

    function getLastInspectionDate(terminal, rackNumber) {
      const inspectionData = JSON.parse(localStorage.getItem('inspectionData') || '{}');
      const key = `${terminal}-${rackNumber}`;
      const rackData = inspectionData[key];
      return rackData ? rackData.lastInspection : null;
    }

    // Simple filtering - NO complex logic
    function filterLocations() {
      const system = document.getElementById("systemFilter").value;
      const municipality = document.getElementById("municipalityFilter").value.toLowerCase();
      const statusFilter = document.getElementById("statusFilter").value;
      const search = document.getElementById("searchInput").value.toLowerCase();
      
      // Store filters
      localStorage.setItem('currentFilters', JSON.stringify({
        system, municipality, statusFilter, search
      }));
      
      document.querySelectorAll(".location-card").forEach(card => {
        const cardSystem = card.dataset.system;
        const cardMunicipality = card.dataset.municipality.toLowerCase();
        const cardName = card.dataset.name;
        const cardTerminal = card.dataset.terminal.toLowerCase();
        
        let matches = (
          (!system || cardSystem === system) &&
          (!municipality || cardMunicipality.includes(municipality)) &&
          (!search || cardName.includes(search) || cardTerminal.includes(search))
        );
        
        // Filter by inspection status
        if (matches && statusFilter) {
          let hasMatchingStatus = false;
          const terminal = card.dataset.terminal;
          const location = ALL_LOCATIONS.find(loc => loc.terminal === terminal);
          
          if (location) {
            for (let i = 1; i <= location.racks; i++) {
              const inspectionStatus = getInspectionStatus(terminal, i);
              if (inspectionStatus === statusFilter) {
                hasMatchingStatus = true;
                break;
              }
            }
          }
          
          matches = hasMatchingStatus;
        }
        
        card.style.display = matches ? "block" : "none";
      });
    }

    // Restore filters after update - simplified
    function restoreFilters() {
      const savedFilters = JSON.parse(localStorage.getItem('currentFilters') || '{}');
      
      // Only restore if we have saved filters
      if (Object.keys(savedFilters).length === 0) return;
      
      if (savedFilters.system) {
        document.getElementById("systemFilter").value = savedFilters.system;
        updateMunicipalities(); // Update municipality options for this system
      }
      
      if (savedFilters.municipality) {
        document.getElementById("municipalityFilter").value = savedFilters.municipality;
      }
      
      if (savedFilters.statusFilter) {
        document.getElementById("statusFilter").value = savedFilters.statusFilter;
      }
      
      if (savedFilters.search) {
        document.getElementById("searchInput").value = savedFilters.search;
      }
      
      // Apply the restored filters
      filterLocations();
    }

    // Export inspection report
    function exportInspectionReport() {
      const inspectionData = JSON.parse(localStorage.getItem('inspectionData') || '{}');
      const inspectionLog = JSON.parse(localStorage.getItem('inspectionLog') || '[]');
      
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "Terminal,Lokacija,Ključavnica,Status pregleda,Zadnji pregled,Naslednji pregled,Trenutno stanje,Opombe,Serviser\n";
      
      ALL_LOCATIONS.forEach(location => {
        for (let i = 1; i <= location.racks; i++) {
          const key = `${location.terminal}-${i}`;
          const rackData = inspectionData[key] || {};
          const inspectionStatus = getInspectionStatus(location.terminal, i);
          const nextDue = getNextInspectionDate(rackData.lastInspection);
          
          const row = [
            location.terminal,
            location.name,
            i,
            inspectionStatus === 'overdue' ? 'ZAMUJEN' : 
            inspectionStatus === 'due-soon' ? 'KMALU' : 'V REDU',
            rackData.lastInspection ? new Date(rackData.lastInspection).toLocaleDateString('sl-SI') : 'Nikoli',
            nextDue.toLocaleDateString('sl-SI'),
            rackData.currentStatus || 'Ni podatka',
            (rackData.notes || '').replace(/,/g, ';'),
            rackData.inspector || 'Ni podatka'
          ].map(field => `"${field}"`).join(',');
          
          csvContent += row + "\n";
        }
      });
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `pregled_porocilo_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Show inspection logs modal
    function showInspectionLogs() {
      document.getElementById('logsModal').style.display = 'block';
      loadInspectionLogs();
      populateLogFilters();
    }

    function closeLogsModal() {
      document.getElementById('logsModal').style.display = 'none';
    }

    function populateLogFilters() {
      const logs = JSON.parse(localStorage.getItem('inspectionLog') || '[]');
      const terminals = [...new Set(logs.map(log => log.terminal))].sort();
      
      const terminalFilter = document.getElementById('logTerminalFilter');
      terminalFilter.innerHTML = '<option value="">Vsi terminali</option>';
      
      terminals.forEach(terminal => {
        const location = ALL_LOCATIONS.find(loc => loc.terminal === terminal);
        const locationName = location ? location.name : terminal;
        terminalFilter.innerHTML += `<option value="${terminal}">${terminal} - ${locationName}</option>`;
      });
    }

    function loadInspectionLogs() {
      const logs = JSON.parse(localStorage.getItem('inspectionLog') || '[]');
      const logsContent = document.getElementById('logsContent');
      
      if (logs.length === 0) {
        logsContent.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 2rem;">Ni zapisov pregledov.</p>';
        return;
      }
      
      displayLogs(logs);
    }

    function displayLogs(logs) {
      const logsContent = document.getElementById('logsContent');
      
      // Sort logs by timestamp (newest first)
      const sortedLogs = logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      let html = '';
      sortedLogs.forEach((log, index) => {
        const location = ALL_LOCATIONS.find(loc => loc.terminal === log.terminal);
        const locationName = location ? location.name : 'Neznana lokacija';
        const date = new Date(log.timestamp);
        const statusColor = getStatusColor(log.newStatus);
        const oldStatusColor = getStatusColor(log.oldStatus);
        
        html += `
          <div style="border: 1px solid #eee; border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem; background: #f9f9f9;" data-log-index="${index}">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
              <div>
                <strong style="color: var(--text-dark);">${locationName}</strong>
                <span style="color: var(--text-light); font-size: 0.9rem;">(${log.terminal})</span>
                <div style="font-size: 0.9rem; color: var(--text-light);">
                  Ključavnica ${log.rackNumber} • ${date.toLocaleDateString('sl-SI')} ${date.toLocaleTimeString('sl-SI', {hour: '2-digit', minute: '2-digit'})}
                </div>
              </div>
              <div style="font-size: 0.8rem; color: var(--text-light);">
                ${log.inspector}
              </div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
              <span style="padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; ${oldStatusColor}">
                ${log.oldStatus || 'Brez statusa'}
              </span>
              <span style="color: var(--text-light);">→</span>
              <span style="padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; ${statusColor}">
                ${log.newStatus}
              </span>
            </div>
            
            ${log.notes ? `<div style="background: white; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; border-left: 3px solid var(--primary);">
              <strong>Opomba:</strong> ${log.notes}
            </div>` : ''}
          </div>
        `;
      });
      
      logsContent.innerHTML = html;
    }

    function getStatusColor(status) {
      switch(status) {
        case 'BP': return 'background: var(--ok); color: white;';
        case 'X': return 'background: var(--fail); color: white;';
        case 'NP': return 'background: var(--warn); color: white;';
        case 'NZ': return 'background: var(--lockfail); color: white;';
        case 'NO': return 'background: var(--unlockfail); color: white;';
        default: return 'background: #ccc; color: black;';
      }
    }

    function filterLogs() {
      const searchTerm = document.getElementById('logSearch').value.toLowerCase();
      const terminalFilter = document.getElementById('logTerminalFilter').value;
      const statusFilter = document.getElementById('logStatusFilter').value;
      const dateFilter = document.getElementById('logDateFilter').value;
      
      let logs = JSON.parse(localStorage.getItem('inspectionLog') || '[]');
      
      // Filter logs
      let filteredLogs = logs.filter(log => {
        const location = ALL_LOCATIONS.find(loc => loc.terminal === log.terminal);
        const locationName = location ? location.name.toLowerCase() : '';
        
        // Search filter
        const matchesSearch = !searchTerm || 
          locationName.includes(searchTerm) ||
          log.terminal.toLowerCase().includes(searchTerm) ||
          log.inspector.toLowerCase().includes(searchTerm);
        
        // Terminal filter
        const matchesTerminal = !terminalFilter || log.terminal === terminalFilter;
        
        // Status filter
        const matchesStatus = !statusFilter || log.newStatus === statusFilter;
        
        // Date filter
        let matchesDate = true;
        if (dateFilter) {
          const logDate = new Date(log.timestamp);
          const now = new Date();
          const daysDiff = Math.floor((now - logDate) / (1000 * 60 * 60 * 24));
          
          switch(dateFilter) {
            case 'today':
              matchesDate = daysDiff === 0;
              break;
            case 'week':
              matchesDate = daysDiff <= 7;
              break;
            case 'month':
              matchesDate = daysDiff <= 30;
              break;
          }
        }
        
        return matchesSearch && matchesTerminal && matchesStatus && matchesDate;
      });
      
      displayLogs(filteredLogs);
    }
    function goBackToBaza() {
      // Poskusi več načinov vrnitve v BAZO
      if (window.opener && !window.opener.closed) {
        // Če je okno odprto iz drugega okna, se vrni
        window.opener.focus();
        window.close();
      } else if (window.history.length > 1) {
        // Če obstaja zgodovina, pojdi nazaj
        window.history.back();
      } else {
        // Kot zadnja možnost, preusmeri na glavno stran
        window.location.href = 'nomago_baza_portal.html';
      }
    }

    // Status setting functions
    let currentStatus = null;
    let hoveredSelect = null;

    function setStatus(status) {
      currentStatus = status;
      if (hoveredSelect) {
        hoveredSelect.value = status;
        updateRackStatus(hoveredSelect);
      }
    }

    function updateLocationDisplay() {
      // Store current filters BEFORE re-rendering
      const savedFilters = JSON.parse(localStorage.getItem('currentFilters') || '{}');
      
      // Re-render locations to update visual indicators
      renderLocations();
      
      // Restore filters EXACTLY as they were - WITHOUT calling updateMunicipalities
      if (savedFilters.system) {
        document.getElementById("systemFilter").value = savedFilters.system;
        // DON'T call updateMunicipalities() here - it would reset municipality selection
      }
      
      if (savedFilters.municipality) {
        // Directly set the municipality value - the options should already exist
        const municipalitySelect = document.getElementById("municipalityFilter");
        if (Array.from(municipalitySelect.options).some(opt => opt.value === savedFilters.municipality)) {
          municipalitySelect.value = savedFilters.municipality;
        }
      }
      
      if (savedFilters.statusFilter) {
        document.getElementById("statusFilter").value = savedFilters.statusFilter;
      }
      
      if (savedFilters.search) {
        document.getElementById("searchInput").value = savedFilters.search;
      }
      
      // Apply the exact same filters
      filterLocations();
    }

    // Enhanced municipalities update
    function updateMunicipalities() {
      const system = document.getElementById("systemFilter").value;
      const municipalitySelect = document.getElementById("municipalityFilter");
      
      municipalitySelect.innerHTML = "<option value=''>Vse občine</option>";
      
      if (system) {
        const municipalities = new Set();
        ALL_LOCATIONS.forEach(loc => {
          if (loc.system === system) {
            municipalities.add(loc.municipality);
          }
        });
        
        Array.from(municipalities).sort().forEach(m => {
          municipalitySelect.innerHTML += `<option value="${m}">${m}</option>`;
        });
      } else {
        const allMunicipalities = new Set();
        ALL_LOCATIONS.forEach(loc => allMunicipalities.add(loc.municipality));
        
        Array.from(allMunicipalities).sort().forEach(m => {
          municipalitySelect.innerHTML += `<option value="${m}">${m}</option>`;
        });
      }
      
      filterLocations();
    }

    // Data for all locations (same as original)
    const ALL_LOCATIONS = [
      // Ljubljana in Medvode
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "Kongresni trg", terminal: "87016", racks: 8 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "BTC City - Kristalna palača", terminal: "87020", racks: 3 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "BTC City - Dvorana A", terminal: "87021", racks: 6 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "BTC City - Atlantis", terminal: "87022", racks: 3 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "BTC City - Dvorana 18", terminal: "87023", racks: 6 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "Stolpnica Delo - Equinox", terminal: "87024", racks: 4 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "Big Bang - Trg mladih", terminal: "87025", racks: 5 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "Big Bang - Francoska ulica", terminal: "87026", racks: 5 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "Nomago - Središka ulica", terminal: "87027", racks: 3 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "Črnuče", terminal: "87028", racks: 5 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "Zalog", terminal: "87029", racks: 5 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "Ekonomska fakulteta", terminal: "87030", racks: 8 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "ISIC - Trg Ajdovščina", terminal: "87031", racks: 5 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "Pop TV - Kranjčeva ulica", terminal: "87032", racks: 5 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "Supernova Šiška", terminal: "87033", racks: 5 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "Rotonda", terminal: "87034", racks: 5 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "Glince - Tržaška c.", terminal: "87035", racks: 5 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "Four Points by Sheraton Ljubljana Mons", terminal: "87036", racks: 3 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "Stara cerkev - Celovška cesta", terminal: "87037", racks: 5 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "E. Leclerc vhod", terminal: "87038", racks: 3 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "E. Leclerc garaža", terminal: "87039", racks: 3 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "Novartis", terminal: "87040", racks: 10 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "Gimnazija Šiška", terminal: "87041", racks: 7 },
      { system: "Ljubljana in Medvode", municipality: "Ljubljana", name: "Čad", terminal: "87042", racks: 4 },
      { system: "Ljubljana in Medvode", municipality: "Medvode", name: "Preska", terminal: "87090", racks: 3 },
      { system: "Ljubljana in Medvode", municipality: "Medvode", name: "Svetje", terminal: "87087", racks: 3 },
      { system: "Ljubljana in Medvode", municipality: "Medvode", name: "Železniška postaja Medvode", terminal: "87089", racks: 5 },
      { system: "Ljubljana in Medvode", municipality: "Medvode", name: "Tržnica Medvode", terminal: "87088", racks: 4 },
      { system: "Ljubljana in Medvode", municipality: "Dobrova-Polhov Gradec", name: "P+R Dobrova", terminal: "87086", racks: 5 },

      // GO2GO
      { system: "GO2GO", municipality: "Nova Gorica", name: "Pristava", terminal: "59118", racks: 6 },
      { system: "GO2GO", municipality: "Nova Gorica", name: "Cankarjeva ul. - sever", terminal: "59115", racks: 8 },
      { system: "GO2GO", municipality: "Nova Gorica", name: "Kidričeva - center", terminal: "5905", racks: 10 },
      { system: "GO2GO", municipality: "Nova Gorica", name: "Šempeter - pošta", terminal: "5907", racks: 8 },
      { system: "GO2GO", municipality: "Nova Gorica", name: "Gradnikove brigade - sever", terminal: "5901", racks: 8 },
      { system: "GO2GO", municipality: "Nova Gorica", name: "Kromberk - Loke", terminal: "59117", racks: 6 },
      { system: "GO2GO", municipality: "Nova Gorica", name: "Prvomajska ul. - Supernova", terminal: "59109", racks: 10 },
      { system: "GO2GO", municipality: "Nova Gorica", name: "Rožna Dolina - zahod", terminal: "5903", racks: 6 },
      { system: "GO2GO", municipality: "Nova Gorica", name: "Gradnikove brigade - jug", terminal: "59108", racks: 6 },
      { system: "GO2GO", municipality: "Nova Gorica", name: "EPIC - Železniška postaja", terminal: "59110", racks: 10 },
      { system: "GO2GO", municipality: "Nova Gorica", name: "Solkan - Hotel Sabotin", terminal: "59111", racks: 7 },
      { system: "GO2GO", municipality: "Nova Gorica", name: "Erjavčeva ulica - Športni park", terminal: "59112", racks: 6 },
      { system: "GO2GO", municipality: "Nova Gorica", name: "Solkan - Kajak center", terminal: "59113", racks: 6 },
      { system: "GO2GO", municipality: "Nova Gorica", name: "Solkan - Ul. Milojke Štrukelj", terminal: "59114", racks: 7 },
      { system: "GO2GO", municipality: "Nova Gorica", name: "Cankarjeva ul. - Šolski center", terminal: "59120", racks: 10 },
      { system: "GO2GO", municipality: "Nova Gorica", name: "Kromberk KS", terminal: "59116", racks: 5 },
      { system: "GO2GO", municipality: "Nova Gorica", name: "Rožna dolina - vzhod", terminal: "59119", racks: 7 },
      { system: "GO2GO", municipality: "Gorizia", name: "Università degli studi di Udine", terminal: "5933", racks: 2 },
      { system: "GO2GO", municipality: "Gorizia", name: "Stazione FS", terminal: "5931", racks: 2 },
      { system: "GO2GO", municipality: "Gorizia", name: "Piazza della Vittoria", terminal: "5932", racks: 2 },
      { system: "GO2GO", municipality: "Gorizia", name: "Comune", terminal: "5934", racks: 7 },
      { system: "GO2GO", municipality: "Šempeter-Vrtojba", name: "Šempeter - pošta", terminal: "5907", racks: 8 },

      // KOLESCE
      { system: "KOLESCE", municipality: "Celje", name: "Krekov trg", terminal: "3250", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Trubarjeva ulica", terminal: "5941", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Avtobusna postaja", terminal: "3255", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Zagrad", terminal: "3294", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Levstikova ulica", terminal: "3263", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Plava Laguna", terminal: "5940", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Ribarjeva ulica", terminal: "5943", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Mariborska cesta - Lidl", terminal: "3291", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Mariborska cesta – TUŠ", terminal: "3256", racks: 8 },
      { system: "KOLESCE", municipality: "Celje", name: "Lava", terminal: "3260", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Tkalska ulica", terminal: "3264", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Nova vas", terminal: "3259", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Ljubečna", terminal: "5951", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Pod lipami", terminal: "5945", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Citycenter", terminal: "3265", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Ostrožno", terminal: "3261", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Na zelenici - TUŠ", terminal: "3253", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Milčinskega ulica", terminal: "5946", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Bolnica Celje", terminal: "3254", racks: 12 },
      { system: "KOLESCE", municipality: "Celje", name: "Spodnji grad", terminal: "3292", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "P+R Ulica XIV. divizije", terminal: "3293", racks: 36 },
      { system: "KOLESCE", municipality: "Celje", name: "Dečkova cesta - Ingrad", terminal: "5942", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Kladivar", terminal: "3290", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Prešernova ulica", terminal: "3251", racks: 14 },
      { system: "KOLESCE", municipality: "Celje", name: "Celjski sejem", terminal: "5947", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Polule", terminal: "5948", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Teharje", terminal: "5950", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Trnovlje - cesta A", terminal: "5966", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Dečkova cesta", terminal: "3262", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Mirna pot - pokopališče", terminal: "5949", racks: 10 },
      { system: "KOLESCE", municipality: "Celje", name: "Škofja vas", terminal: "5955", racks: 6 },
      { system: "KOLESCE", municipality: "Celje", name: "Šmartno v R. dolini", terminal: "5956", racks: 5 },
      { system: "KOLESCE", municipality: "Celje", name: "Trnovlje", terminal: "5957", racks: 4 },
      { system: "KOLESCE", municipality: "Celje", name: "Lopata", terminal: "5954", racks: 5 },
      { system: "KOLESCE", municipality: "Celje", name: "TEST delavnica CE", terminal: "7777", racks: 0 },
      { system: "KOLESCE", municipality: "Šentjur", name: "Zdravstveni dom Šentjur", terminal: "3296", racks: 6 },
      { system: "KOLESCE", municipality: "Šentjur", name: "AP Miloša Zidanška", terminal: "3299", racks: 6 },
      { system: "KOLESCE", municipality: "Šentjur", name: "Železniška postaja Šentjur", terminal: "3241", racks: 16 },
      { system: "KOLESCE", municipality: "Šentjur", name: "IKC Šentjur", terminal: "3242", racks: 8 },
      { system: "KOLESCE", municipality: "Šentjur", name: "Zgornji trg", terminal: "3243", racks: 6 },
      { system: "KOLESCE", municipality: "Šentjur", name: "Mestni trg", terminal: "3295", racks: 10 },
      { system: "KOLESCE", municipality: "Šentjur", name: "Osnovna šola Hruševec", terminal: "3297", racks: 6 },
      { system: "KOLESCE", municipality: "Šentjur", name: "Športni park Rifnik", terminal: "3298", racks: 6 },
      { system: "KOLESCE", municipality: "Šentjur", name: "Proseniško", terminal: "5959", racks: 6 },
      { system: "KOLESCE", municipality: "Šentjur", name: "Grobelno", terminal: "5967", racks: 6 },
      { system: "KOLESCE", municipality: "Štore", name: "Lipa - Mercator", terminal: "3287", racks: 5 },
      { system: "KOLESCE", municipality: "Braslovče", name: "Braslovče trg", terminal: "5953", racks: 6 },
      { system: "KOLESCE", municipality: "Žalec", name: "Levec", terminal: "5958", racks: 6 },
      { system: "KOLESCE", municipality: "Žalec", name: "I. osnovna šola", terminal: "3275", racks: 6 },
      { system: "KOLESCE", municipality: "Žalec", name: "Pokopališče", terminal: "3274", racks: 6 },
      { system: "KOLESCE", municipality: "Žalec", name: "Občina Žalec", terminal: "3276", racks: 6 },
      { system: "KOLESCE", municipality: "Žalec", name: "Čopova ulica", terminal: "3272", racks: 6 },
      { system: "KOLESCE", municipality: "Žalec", name: "Šempeter", terminal: "3249", racks: 6 },
      { system: "KOLESCE", municipality: "Žalec", name: "AP Žalec", terminal: "3273", racks: 6 },
      { system: "KOLESCE", municipality: "Žalec", name: "Petrovče", terminal: "3248", racks: 6 },
      { system: "KOLESCE", municipality: "Žalec", name: "Vrbje", terminal: "5968", racks: 6 },
      { system: "KOLESCE", municipality: "Žalec", name: "Arnovski Gozd", terminal: "5965", racks: 6 },
      { system: "KOLESCE", municipality: "Laško", name: "Dvorana Tri Lilije", terminal: "3270", racks: 6 },
      { system: "KOLESCE", municipality: "Laško", name: "Železniška postaja Laško", terminal: "3268", racks: 8 },
      { system: "KOLESCE", municipality: "Laško", name: "Thermana Laško", terminal: "3269", racks: 6 },
      { system: "KOLESCE", municipality: "Laško", name: "Trubarjevo nabrežje", terminal: "3267", racks: 6 },
      { system: "KOLESCE", municipality: "Laško", name: "TIC Rimske Toplice", terminal: "3271", racks: 6 },
      { system: "KOLESCE", municipality: "Laško", name: "Rečica", terminal: "3246", racks: 4 },
      { system: "KOLESCE", municipality: "Laško", name: "Šentrupert", terminal: "5960", racks: 4 },
      { system: "KOLESCE", municipality: "Laško", name: "Jurklošter", terminal: "5961", racks: 4 },
      { system: "KOLESCE", municipality: "Zreče", name: "Občina Zreče", terminal: "3279", racks: 6 },
      { system: "KOLESCE", municipality: "Zreče", name: "Unior", terminal: "3281", racks: 6 },
      { system: "KOLESCE", municipality: "Zreče", name: "Hotel Dobrava", terminal: "3280", racks: 6 },
      { system: "KOLESCE", municipality: "Zreče", name: "Večgeneracijski center", terminal: "3282", racks: 6 },
      { system: "KOLESCE", municipality: "Slovenske Konjice", name: "AP Slovenske Konjice", terminal: "3283", racks: 6 },
      { system: "KOLESCE", municipality: "Slovenske Konjice", name: "Mizarska cesta", terminal: "3284", racks: 6 },
      { system: "KOLESCE", municipality: "Slovenske Konjice", name: "Gimnazija Slovenske Konjice", terminal: "3285", racks: 6 },
      { system: "KOLESCE", municipality: "Slovenske Konjice", name: "Poslovna cona LIP", terminal: "3286", racks: 6 },
      { system: "KOLESCE", municipality: "Vojnik", name: "Vojnik", terminal: "5952", racks: 6 },
      { system: "KOLESCE", municipality: "Polzela", name: "Polzela", terminal: "3277", racks: 5 },
      { system: "KOLESCE", municipality: "Polzela", name: "Športna dvorana Polzela", terminal: "3278", racks: 5 },
      { system: "KOLESCE", municipality: "Sevnica", name: "Občina Sevnica", terminal: "5962", racks: 5 },
      { system: "KOLESCE", municipality: "Sevnica", name: "Trg Svobode", terminal: "5964", racks: 5 },
      { system: "KOLESCE", municipality: "Sevnica", name: "OŠ Boštanj", terminal: "5969", racks: 5 },

      // ZANAPREJ
      { system: "ZANAPREJ", municipality: "Zagorje ob Savi", name: "Kisovec", terminal: "5998", racks: 10 },
      { system: "ZANAPREJ", municipality: "Zagorje ob Savi", name: "Helfar", terminal: "5996", racks: 10 },
      { system: "ZANAPREJ", municipality: "Zagorje ob Savi", name: "Evropark", terminal: "5997", racks: 10 },
      { system: "ZANAPREJ", municipality: "Zagorje ob Savi", name: "Mestna ploščad", terminal: "5994", racks: 10 },
      { system: "ZANAPREJ", municipality: "Zagorje ob Savi", name: "Železniška postaja Zagorje", terminal: "5995", racks: 10 },
      { system: "ZANAPREJ", municipality: "Zagorje ob Savi", name: "Toplice", terminal: "5963", racks: 10 },
      { system: "ZANAPREJ", municipality: "Zagorje ob Savi", name: "Izlake", terminal: "5999", racks: 10 }
    ];

    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      initializeInspectionData();
      renderLocations();
      updateMunicipalities(); // Initial population of municipalities
      updateAlerts();
      updateSummary();
      
      // Add event listeners
      document.getElementById('systemFilter').addEventListener('change', function() {
        updateMunicipalities();
        filterLocations();
      });
      
      document.getElementById('municipalityFilter').addEventListener('change', filterLocations);
      document.getElementById('statusFilter').addEventListener('change', filterLocations);
      document.getElementById('searchInput').addEventListener('input', filterLocations);
      
      // Restore filters if they exist
      restoreFilters();
    });
  </script>
</body>
</html>